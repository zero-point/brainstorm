<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Brainstorm</title>
<link rel="shortcut icon" type="image/png" href="favicon.ico"/>
<link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap-responsive.min.css" />

<style type="text/css">
#column1-wrap {
    float: left;
    width: 100%;
}
#column1 {
    margin-right: 200px;
}
#column2 {
    float: left;
    width: 200px;
    margin-left: -200px;
}

#feedback {
     transition:width 1s;
     -moz-transition:width 1s; /* Firefox 4 */
     -webkit-transition:width 1s; /* Safari and Chrome */
     -o-transition:width 1s; /* Opera */
     background: #3399cc url(feedback_button_1.png) no-repeat 35% 50%;
     position:fixed;
     width:30px;
     height:150px;
     top:30%;
     right:0px;
}

#feedback:hover
{
     width:50px;
}
</style>

<style type="text/css">
.modal {
	margin-left: 0;
	margin-top: 0px;
	left: 10px;
	top: 10px;
	width: 400px;
}

.sector-label {
	cursor:pointer;
}
.sector-label-edit {
	display:none;
}
.edit .sector-label {
	display:none;
}
.edit .sector-label-edit {
	display:block;
}
</style>
<script type="text/javascript" src="scripts/jquery-1.11.1.js"></script>
<script type="text/javascript" src="scripts/html2canvas.js"></script>
<script type="text/javascript" src="scripts/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="scripts/underscore.js"></script>
<script type="text/javascript" src="scripts/backbone.js"></script>
<script type="text/javascript" src="scripts/cake.js"></script>
<script type="text/template" id="popup-template">
<div class="modal sector-popup">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">&times;</a>
		<% if (label) { %>
			<div class="sector-label"><h3 style="display:inline"><%= label %></h3> <i class="icon-pencil"></i></div>
			<p class="sector-label-edit"><input type="text" class="input-xlarge" value="<%= label %>" /></p>
		<% } %>
	</div>
	<form class="form-vertical">
		<div class="modal-body">
			<h4>Split into how many sectors?</h4>
			<p>&nbsp;</p>Share
			<div class="control-group">
				<div class="controls"><input type="text" class="input-xlarge" placeholder="Just one sector: not an option, expand ideas!"></div>
				<div class="controls"><input type="text" class="input-xlarge" placeholder="Two sectors: not bad, good for..."></div>
				<div class="controls"><input type="text" class="input-xlarge" placeholder="Three sectors: good..."></div>
				<div class="controls"><input type="text" class="input-xlarge" placeholder="Four sectors: ambitious..."></div>
			</div>
		</div>
		<div class="modal-footer">
			<input id="submitBtn" type="submit" class="btn btn-primary" value="Add sectors" />
			<a href="#" class="btn" data-dismiss="modal">Close</a>
		</div>
	</form>
</div>
</script>

<script src="scripts/jquery.jeditable.js" type="text/javascript" charset="utf-8"></script>
<script>
	$(document).ready(function() {

//		$('#title').editable(function() {
//			document.getElementById('title').innerHTML;
//		});

		$('.edit').editable('file:///home/futurenode/workspace/final-brainstorm/brainstorm.html/save.php', {
 			indicator : 'Saving...',
			tooltip   : 'Click to edit...'
		});
		
		$('.edit_area').editable('file:///home/futurenode/workspace/final-brainstorm/brainstorm.html/save.php', { 
			type      : 'textarea',
			cancel    : 'Cancel',
			submit    : 'OK',
			indicator : '<img src="img/indicator.gif">',
			tooltip   : 'Click to edit...'
		});
	});
</script>

<script type="text/javascript">
var RADIUS = 50;
var CANVAS, MID_X, MID_Y = null;


function getRandomColor() {
	return '#' + (function co(lor){ return (lor += [0,1,2,3,4,5,6,7,8,9,'a','b','c','d','e','f'][Math.floor(Math.random()*16)]) && (lor.length == 6) ?  lor : co(lor); })('');
}

/**
 * HSV to RGB color conversion
 *
 * H runs from 0 to 360 degrees
 * S and V run from 0 to 100
 * 
 * Ported from the excellent java algorithm by Eugene Vishnevsky at:
 * http://www.cs.rit.edu/~ncs/color/t_convert.html
 */
function hsvToRgb(h, s, v) {
	var r, g, b;
	var i;
	var f, p, q, t;
	
	// Make sure our arguments stay in-range
	h = Math.max(0, Math.min(360, h));
	s = Math.max(0, Math.min(100, s));
	v = Math.max(0, Math.min(100, v));
	
	// We accept saturation and value arguments from 0 to 100 because that's
	// how Photoshop represents those values. Internally, however, the
	// saturation and value are calculated from a range of 0 to 1. We make
	// That conversion here.
	s /= 100;
	v /= 100;
	
	if(s == 0) {
		// Achromatic (grey)
		r = g = b = v;
		return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
	}
	
	h /= 60; // sector 0 to 5
	i = Math.floor(h);
	f = h - i; // factorial part of h
	p = v * (1 - s);
	q = v * (1 - s * f);
	t = v * (1 - s * (1 - f));

	switch(i) {
		case 0:
			r = v;
			g = t;
			b = p;
			break;
			
		case 1:
			r = q;
			g = v;
			b = p;
			break;
			
		case 2:
			r = p;
			g = v;
			b = t;
			break;
			
		case 3:
			r = p;
			g = q;
			b = v;
			break;
			
		case 4:
			r = t;
			g = p;
			b = v;
			break;
			
		default: // case 5:
			r = v;
			g = p;
			b = q;
	}
	
	return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

$(function() {

CANVAS = new Canvas($("#canvas-container").get(0), $(window).width(), $(window).height());
//TODO bind on window resize: http://stackoverflow.com/questions/4037212/html-canvas-full-screen
MID_X = CANVAS.width/2;
MID_Y = CANVAS.height/2;

window.Sector = Backbone.Model.extend({
	initialize: function() {
		this.set("level", this.get("parent") ? this.get("parent").get("level")+1 : 0);
		this.set({
			radius: (this.get("level")+0.5) * RADIUS, //TODO make nice
			children: new (Backbone.Collection.extend({ model : Sector })),
			offsetAngle: this.get("parent") ? this.get("parent").get("offsetAngle") : 0,
			angle: this.get("parent") ? this.get("parent").get("angle") : Math.PI*2,
			view: new SectorView({ model: this })
		});
		this.on("change:offsetAngle change:angle", this.setChildPositions, this);
		this.get("children").on("add", this.setChildPositions, this);
	},

    toggle: function() {
      this.save({done: !this.get("done")});
    },
	
	setLabel: function(label) {
		this.set("label", label);
	},
	
	addChildClockwiseOf: function(childNumber, label) {
		var child = new Sector({ label: label, parent: this });
		this.get("children").add(child); //TODO at correct index
		return child;
	},

	addChildAnticlockwiseOf: function(childNumber, label) {
		return this.addChildClockwiseOf((childNumber-1) % this.get("children").length, label);
	},
	
	addChild: function(label) {
		return this.addChildClockwiseOf(this.get("children").length-1, label);
	},
	
	setChildPositions: function() {
		var childOffsetAngle = this.get("offsetAngle");
		var childAngle = this.get("angle")/this.get("children").length;

		this.get("children").each(function(child) {
			child.set({
				angle: childAngle,
				offsetAngle: childOffsetAngle
			});
			childOffsetAngle += childAngle
		});
	},
	
	addClockwise: function() {
		alert("addClockwise");
	},
});

var root = new Sector({
	label: "New Brainstorm"
});
});

window.FormPopup = Backbone.View.extend({
	template: _.template($('#popup-template').html()),
	
	events: {
		"click .sector-label" : "edit",
		"keypress .sector-label-edit input" : "setLabel"
    		},
	
	render: function() {
		var view = this;

		this.$el.html(this.template(this.model.toJSON()));
		this.$el.modal({
			backdrop: false
		});
		this.$el.on("hidden", function() {
			view.remove();
		});

		this.$el.find("form").submit(function() {
			$(this).find("input:text").each(function() {
				var label = $(this).val();
				if (label.length > 0){
						view.model.addChild(label);
				}
			});
			view.$el.modal("hide");
			return false;
		});
	},

	edit: function() {
		this.$el.addClass("edit");
		this.$el.find(".sector-label-edit input").focus();
	},
	
	setLabel: function(e) {
		if (e.keyCode != 13)
			return;
		var newLabel = this.$el.find(".sector-label-edit input").val();
		this.model.set("label", newLabel);
		document.getElementById('title').innerHTML = newLabel;
		this.$el.find(".sector-label h3").html(newLabel);
		this.$el.removeClass("edit");
	},
});

window.SectorView = Backbone.View.extend({
	initialize: function() {
		this.model.bind("change", this.render, this);
		this.model.bind('destroy', this.remove, this);
		this.setElement(null);
	},
	
	events: {
		"mouseover": "popOut",
		"mouseout": "popIn",
		"click": "showInfo"
    },
	
	render: function() {
		var radius = this.model.get("radius");
		
		if (this.model.get("level") == 0) {
			if (this.el != null) return;
			this.setElement(new Circle(radius, {
				x: CANVAS.width/2,
				y: CANVAS.height/2,
				fill: getRandomColor(),
			}));
			CANVAS.append(this.el);
		} else {
			var offsetAngle = this.model.get("offsetAngle");
			var angle = this.model.get("angle");

			if (this.el == null) {
				this.setElement(new Circle(radius, {
					x: CANVAS.width/2,
					y: CANVAS.height/2,
					startAngle: offsetAngle + angle,
					endAngle: offsetAngle + angle,
					zIndex: -this.model.get("level"),
					includeCenter:true,
				}));
				CANVAS.append(this.el);
			}

			this.el.fill = hsvToRgb((offsetAngle+angle/2)*180/Math.PI, 22, 200); //100-((this.model.get("level")-1)*10)); //TODO make nice
			this.el.animateTo('startAngle', offsetAngle, 500, 'sine');
			this.el.animateTo('endAngle', offsetAngle + angle, 500, 'sine');
			
			var xx = radius * Math.sin(Math.PI/2 + offsetAngle + angle/2);
			var yy = -radius * Math.cos(Math.PI/2 + offsetAngle + angle/2);
			
			var text = this.el.getElementById("text");
			if (text == null) {
				text = new TextNode(Drawable, {
					id: "text",
					maxWidth:50,
					cx: xx,
					cy: yy,
					fill: "#000",
				});
				this.el.append(text);
			}
			
			text.text = this.model.get("label");
			text.animateTo('cx', xx, 10, 'linear');
			text.animateTo('cy', yy, 10, 'linear');
		}
	},
	
	popOut: function() {
		this.el.animateTo('scale', 1.1, 100, 'linear');
	},
	
	popIn: function() {
		this.el.animateTo('scale', 1, 100, 'linear');
	},
	
	showInfo: function() {
		new FormPopup({ model: this.model }).render();
	},
});

function sendMail() {
    var link = "mailto:irinapreda@gmail.com"
             + "?subject=" + escape("Feedback")
    ;

    window.location.href = link;
}

window.onload = function(){
                var canvas = document.getElementById("canvas-container");

                var translatePos = {
                    x: canvas.width / 2,
                    y: canvas.height / 2
                };

                var scale = 1.0;
                var scaleMultiplier = 0.8;
                var startDragOffset = {};
                var mouseDown = false;

                // add button event listeners
                document.getElementById("plus").addEventListener("click", function(){
                    scale /= scaleMultiplier;
                    draw(scale, translatePos);
                }, false);

                document.getElementById("minus").addEventListener("click", function(){
                    scale *= scaleMultiplier;
                    draw(scale, translatePos);
                }, false);

                // add event listeners to handle screen drag
                canvas.addEventListener("mousedown", function(evt){
                    mouseDown = true;
                    startDragOffset.x = evt.clientX - translatePos.x;
                    startDragOffset.y = evt.clientY - translatePos.y;
                });

                canvas.addEventListener("mouseup", function(evt){
                    mouseDown = false;
                });

                canvas.addEventListener("mouseover", function(evt){
                    mouseDown = false;
                });

                canvas.addEventListener("mouseout", function(evt){
                    mouseDown = false;
                });

                canvas.addEventListener("mousemove", function(evt){
                    if (mouseDown) {
                        translatePos.x = evt.clientX - startDragOffset.x;
                        translatePos.y = evt.clientY - startDragOffset.y;
                        draw(scale, translatePos);
                    }
                });

                draw(scale, translatePos);
            };

</script>

</head>
<body onmousedown="return false;">

<div style="padding:15px; position: absolute; min-width: 1300px">
	<div id="column1-wrap"><div id="column1"><b><h3><span class="edit_area" id="title" style="display: inline">New Brainstorm</span></h3></b><br/>
					<div class="btn-group">
						<button type="button" id="plus" class="btn btn-default btn-lg"><b>+</b></button>
						<button type="button" id="minus" class="btn btn-default btn-lg"><b>-</b></button>
					</div>
				</div>
	</div>
	<div id="column2">
		<div class="dropdown">
			<div class="btn-group">			
				<button type="button" id="btnSave" class="btn btn-default btn-lg"><span class="glyphicon glyphicon-star"></span><b>Download</b></button>
				<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
					<span class="caret"></span>
					<span class="sr-only"><b>Share</b></span>
				</button>
				<ul class="dropdown-menu" role="menu">
					<li role="presentation"><a role="menuitem" tabindex="-1" href="#">Email</a></li>
					<li role="presentation"><a role="menuitem" tabindex="-1" href="#">Twitter</a></li>
					<li role="presentation"><a role="menuitem" tabindex="-1" href="#">Facebook</a></li>
				</ul>
			</div>			
		</div>
	</div>
</div>

<div id="feedback" href="#" onclick="sendMail(); return false"></div>
<div id="canvas-container"></div>

<script type="text/javascript" src="bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="bootstrap/js/bootstrap-modal.js"></script>
<script>
	var button = document.getElementById('btnSave');
	button.addEventListener("click", function() {
		html2canvas(document.getElementById('canvas-container'), {
    			onrendered: function(canvas) {
				var img = canvas.toDataURL("image/png");
    				var url = img.replace(/^data:image\/[^;]/, 'data:application/octet-stream');
				location.href = url;
  			}
		});    
	});

</script>
</body>
</html>
